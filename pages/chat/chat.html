<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Petriots | Appointments</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">

  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini" id="bodychat">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="../../index3.html" class="nav-link">Home</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Contact</a>
      </li>
    </ul>

    <!-- Right navbar links -->
  
    <ul class="navbar-nav ml-auto">
      <li class="nav-item dropdown" style="visibility: hidden;">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-comments" style="font-size:larger"></i>
          <span class="badge badge-danger navbar-badge"></span>
        </a>
      </li>
      <li class="nav-item dropdown">
        <a class="btn nav-link" data-toggle="dropdown" id="btnnotifadmin">
          <i class="far fa-bell" style="font-size:larger"></i>
          </a>
          <span class="badge badge-danger navbar-badge" id="notification-count"></span>
          <div class="dropdown-menu dropdown-menu-xl dropdown-menu-right scroll">
             <div id ="admin-notif">
                </div>
        </div>
   </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4" style="background-color: #4154F1;">
    <!-- Brand Logo -->
    <a href="../../index3.html" class="brand-link">
      <img src="../../dist/img/logowhite.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">Petriots</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="../../dist/img/user.png" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">Administrator</a>
        </div>
      </div>

      <!-- SidebarSearch Form -->
 
      <div id="myToastContainer" style="position:fixed;bottom: 0; left: 0; margin-left: 15px; margin-bottom: 25px;"></div>
      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false" >
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item" >
            <a href="../../index.html" class="nav-link" style="background-color: #4154F1; box-shadow: none;">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px; ">
                Dashboard
              </p>
            </a>    
          </li>
          <li class="nav-header">Appointments</li>
              <li class="nav-item">
                <a href="../appointments/summary.html" class="nav-link " >
                  <i class="nav-icon fas fa-calendar-alt"></i>
                  <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">Summary</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="../appointments/request.html" class="nav-link" >
                  <i class="nav-icon fas fa-exclamation-circle"></i>
                  <p style="color: #DCE0FD; font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">Request</p>
                  <span class="badge badge-warning right" id="countReq"></span>
                </a>
              </li>
              <li class="nav-item">
                <a href="../appointments/complete.html" class="nav-link"  >
                  <i class="nav-icon 	far fa-calendar-check"></i>
                  <p style="color: #DCE0FD; font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">Complete</p>
                </a>
              </li>    
          <li class="nav-header">Information</li>

          <li class="nav-item">
            <a href="../information/pet.html" class="nav-link">
              <i class="nav-icon fas fa-paw"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
                Pet
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="../information/owner.html" class="nav-link">
              <i class="nav-icon fas fa-users"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
                Owners
              </p>
            </a>
          </li>
          <li class="nav-header">Analytics</li>
          <li class="nav-item">
            <a href="../analytics/reports.html" class="nav-link" >
              <i class="nav-icon fas fa-vial"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
               Reports
              </p>
              <span class="badge badge-warning right" id="countRep"></span>
            </a>
          </li>
          <li class="nav-header">Others</li>
          <li class="nav-item">
            <a href="../feedback/feedback.html" class="nav-link" >
              <i class="nav-icon fas fa-bullhorn"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
              Feedbacks

              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="../chat/chat.html" class="nav-link active " style="background-color: #5c6cfb;">
              <i class="nav-icon far fa-comment"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
             Messages

              </p>
            </a>
          </li>   
          <li class="nav-item">
            <a href ="" class="nav-link" id="logoutbtn">
              <i class="nav-icon fas fa-sign-out-alt"></i>
              <p style="font-family: Segoe UI, Arial, sans-serif;font-weight: 300; font-size: 15px;">
              Logout

              </p>
            </a>
          </li>               
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="card-container" style="justify-content: center; display: flex;" id="concard">
          <div class="card max-height-vh-70 h-100 overflow-auto overflow-x-hidden mb-5 mb-lg-0" style="height:720px; width: 350 px; margin-top: -35px;">
                <div class="card-header"> Pet Owners</div>
            
              <div class="card-body scroll"  style="height: 600px; width: 100%; max-width: 350px; font-family: Segoe UI, Arial, sans-serif;font-weight: 300;">
                                                          
              </div>
            </div>
            <div class="card" id="cardmessage" style=" display: flex;
            flex-direction: column; margin-top: -35px; height:650px; font-family: Segoe UI, Arial, sans-serif;font-weight: 300;">
                <div class="card-header"  id="ownermessage" >
                  <img src="../../dist/img/user.png" alt="User Avatar" class="avatar avatar-sm img-circle" id="profileid" style="object-fit:cover; width: 50px; height: 50px;">
                  <h7 id="my-heading" style="margin-left: 10px; font-weight: 500;"></h7>
                    </div>
                
                <div class="card-body scroll-message " style="width: 598px;" id="messagebody">
                  
                </div>
                <div class="card-footer" style=" margin-top: -10px ">
                    <form class="align-items-center">
                        <div class="input-group mb-3">
                            <input type="text" placeholder="Type a message..." class="form-control" id="adminmessage">
                            <div class="input-group-append" >
                                <span class="input-group-text" >
                                <a href="#" id="btnsend" >
                                    <i class="fa fa-paper-plane"></i>
                                </a>    
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
              </div>
            <div class="card" style="height: 650px; margin-top: -35px;">
              <div class="card-body"  style="  height: 600px; 
              width: 300px;">
                  <a href="javascript:;" class="d-block p-2">
                  </a>
                  <div class="p-2 text-center">
                      <a href="javascript:;" class="d-block p-2" style="text-align: center; position: relative;">
                        <img src="../../dist/img/user.png" alt="User Avatar" class="avatar avatar-lg img-circle" id="profileids" style="object-fit:cover; width: 90px; height: 90px;">
                      </a>
                      <div class="ml-2 mt-0 mb-0 text-center">
                          <div class="justify-content-between align-items-center">
                              <h5 class="mb-0 mt-1" id ="petownername"></h5>
                              <p class="mb-0 text-sm text-dark font-weight-normal">Pet Owner</p>
                              <a href="" class="text-sm ">View profile</a> 
                          </div>
                      </div>
                  </div>
                  <hr class="my-3">
                  <div class="mx-3">
                      <h6 class="mb-0" style="display: inline;">Owner ID: </h6>
                      <p class="text-sm text-muted font-weight-normal" style="display: inline;" id="ownerid"></p>
                  </div>
                  <hr class="my-3">

                  <div class="mx-3">
                      <div class="d-flex align-items-center mb-3">
                          <i class="fa fa-envelope opacity-7"></i>
                          <div class="ml-3">
                              <h6 class="mb-0" >Email</h6>
                              <span class="text-sm text-primary" id="owneremail" >
                              </span>
                          </div>
                      </div>
                      <div class="d-flex align-items-center">
                          <i class="fa fa-phone opacity-7"></i>
                          <div class="ml-3">
                              <h6 class="mb-0" id="ownerpnum">Phone</h6>
                              <span class="text-sm text-primary" id="pnum">
                              </span>
                          </div>
                      </div>
                  </div>
                <!-- content of third card -->
              </div>
            </div>
          </div>
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <strong>Copyright &copy; 2021-2023 <a href="https://adminlte.io">Petriots</a>.</strong> All rights reserved.
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->
<style>
.scroll {
      max-height:720px;
      overflow: auto;
    }
.scroll-message {
      max-height:520px;
      overflow-y: auto;
    
    }    
.card-container {
  white-space: nowrap; /* prevent cards from wrapping to the next line */
}

.card {
  overflow-x: hidden;  
  max-width:1000px;
  display: inline-block; /* display cards horizontally */
  vertical-align: top; /* align cards to the top */
  margin-right: 20px;
}
   
.bg-custom {
  background-color: #4154F1;
}

.text-message{

  font-size: 12px;
}
body {
  overflow-y: scroll;
}

</style>
<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables  & Plugins -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="../../plugins/jszip/jszip.min.js"></script>
<script src="../../plugins/pdfmake/pdfmake.min.js"></script>
<script src="../../plugins/pdfmake/vfs_fonts.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
<!-- AdminLTE App -->
<script src="../../dist/js/adminlte.min.js"></script>

<!-- Page specific script -->
<script>
  $(function () {
    $("#example1").DataTable({
      "responsive": true, "lengthChange": false, "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
    $('#example2').DataTable({
      "paging": true,
      "lengthChange": false,
      "searching": false,
      "ordering": true,
      "info": true,
      "autoWidth": false,
      "responsive": true,
    });
  });
</script>
<script>

document.getElementById("btnsend").removeAttribute("href");
    document.getElementById("btnsend").style.pointerEvents = "none";
const inputField = document.getElementById("adminmessage");
inputField.addEventListener("input", function() {
  if (inputField.value.length > 0) {
    // There is text inside the input field
    document.getElementById("btnsend").setAttribute("href", "#");
    document.getElementById("btnsend").style.pointerEvents = "auto";
  } else {
    // There is no text inside the input field


    document.getElementById("btnsend").removeAttribute("href");
    document.getElementById("btnsend").style.pointerEvents = "none";
  }
});

var firebaseConfig = {
      apiKey: "AIzaSyCwyVGv24xBXgcupXb6nZAEcuEadNUMsdQ",
        authDomain: "petriots-9ae02.firebaseapp.com",
        databaseURL: "https://petriots-9ae02-default-rtdb.firebaseio.com",
        projectId: "petriots-9ae02",
        storageBucket: "petriots-9ae02.appspot.com",
        messagingSenderId: "728168171570",
        appId: "1:728168171570:web:97301a09052ce3b8fe542b",
        measurementId: "G-GVBQPKNDJ1"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

var database = firebase.database();
var idowner;
var chatNodes;
const usernamed = JSON.parse(localStorage.getItem('username'));

function handleIdOwner(id) {
  // Do something with the idowner value here
  idowner = id;
}
$("#btnsend").prop("disabled", true);
var dataRef = database.ref('PetOwners');
dataRef.once('value').then(function(snapshot) {
  // Create and append HTML elements to display the data
snapshot.forEach(function(childSnapshot) {
   
    var petownerid = childSnapshot.val().ownerid;
    var firstName = childSnapshot.val().firstName;
    var lastName = childSnapshot.val().lastName;
    var email = childSnapshot.val().email;
    var pnum = childSnapshot.val().pnum;
    var photoUrl = childSnapshot.val().photoUrl;
    var fullName  = firstName + " " + lastName;
    var cardBody = document.querySelector('.card-body');


 messageElement = document.createElement('a');
messageElement.setAttribute('href', '#');
messageElement.classList.add('dropdown-item');
messageElement.setAttribute('id', "myPetOwners");
// Add the message HTML code to the message element
messageElement.innerHTML = `
  <div class="media" style="max-width: 100%;">
    <img src="${photoUrl ? photoUrl : '../../dist/img/user.png'}" alt="User Avatar" class="img-size-50 mr-3 img-circle" style="object-fit:cover; width: 50px; height: 50px;" >
    <div class="media-body">
      <h3 class="dropdown-item-title">
        ${fullName }
        <span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
      </h3>
      <p class="text-message">Pet Owner</p>
    </div>
  </div>
  <div class="dropdown-divider"></div>
`;

cardBody.appendChild(messageElement);

// Call the addClickListener function to attach the click event listener to the message element

messageElement.addEventListener("click", function() {

  var messageBody = $("#messagebody");
  var btnmsg = $("#btnsend");

  messageBody.empty();
  chatNodes = usernamed + "-" + petownerid;
  handleIdOwner(petownerid);
  var myHeading = document.querySelector("#my-heading");

// Set the content of the h5 element
    myHeading.textContent = fullName;

    var petOwner = document.querySelector("#petownername");

      // Set the content of the h5 element
      petOwner.textContent = fullName;


      var eMail = document.querySelector("#owneremail");

      // Set the content of the h5 element
      eMail.textContent = email;

      
      var pNum = document.querySelector("#pnum");

      // Set the content of the h5 element
      pNum.textContent = pnum;

      var idOwner = document.querySelector("#ownerid");

// Set the content of the h5 element
      idOwner.textContent = petownerid;


      const myImage = document.getElementById('profileid');

      myImage.src = photoUrl ? photoUrl : '../../dist/img/user.png';

      const myProfile = document.getElementById('profileids');

      myProfile.src = photoUrl ? photoUrl : '../../dist/img/user.png';
  var url = '/AdminLTE/pages/chat/chat.html?chatid=' + encodeURIComponent( chatNodes);
  window.history.pushState(null, null, url);

});

}); 
function getFormattedTimestamp(timestamp) {
  var date = new Date(timestamp);
  var hours = date.getHours();
  var minutes = date.getMinutes();
  var ampm = hours >= 12 ? "pm" : "am";
  hours = hours % 12;
  hours = hours ? hours : 12;
  minutes = minutes < 10 ? "0" + minutes : minutes;
  var strTime = hours + ":" + minutes + " " + ampm;
  return strTime;
    }

  window.onpopstate = function(event) {
  // get the current URL
  var urlParams = new URLSearchParams(window.location.search);
  var chatNoded = urlParams.get("chatid");
  database.ref('Chats/' +  chatNoded).orderByChild('chatid').equalTo(chatNoded).off('child_added');


};
window.addEventListener('popstate', function(event) {

  var urlParams = new URLSearchParams(window.location.search);
  var chatNodes = urlParams.get("chatid");

  var messageBody = $("#messagebody");
  messageBody.empty();

  function addMessage(snapshot) {  
    var messageBody = $("#messagebody");
    // get the message data
    var messageData = snapshot.val().message;
    var sender = snapshot.val().sender;
    var timestamp = snapshot.val().timestamp;
    var chatid = snapshot.val().chatid;

    var urlParams = new URLSearchParams(window.location.search);
     var currentChatNode = urlParams.get("chatid");

 
  if (chatid === currentChatNode) {
    // create HTML elements to display the message
    var messageElements = $("<div>").addClass("row mb-4");
    var colElement = $("<div>").addClass("col-auto");

    // create the message card
    var cardElement = $("<div>").addClass("card text-white");

    // create the card body
    var cardBodyElement = $("<div>").addClass("card-body p-2");

    // add a class to the message element based on the sender
    if (sender === "admin") {
      messageElements.addClass("justify-content-end");
      cardElement.addClass("bg-custom");
      var timestampElement = $("<div>").addClass("d-flex align-items-center justify-content-end text-sm opacity-6");
      var timestampIconElement = $("<i>").addClass("fa fa-check-double mr-1 text-xs");
      var timestampTextElement = $("<small>").text(getFormattedTimestamp(timestamp));

      // create the message text
      var messageTextElement = $("<p>").addClass("mb-1").css({
  "white-space": "pre-wrap",
  "overflow-wrap": "break-word",
  "word-break": "break-all",
  "max-width": "45ch"
}).text(messageData);

      var textLength = messageTextElement.text().length;

      if (textLength > 10) {
          messageTextElement.css("white-space", "pre-wrap");
          messageTextElement.css("overflow-wrap", "break-word");
      }
      // append the message text and timestamp to the card body
      cardBodyElement.append(messageTextElement, timestampElement);
      timestampElement.append(timestampIconElement, timestampTextElement);

    } else {
      messageElements.addClass("justify-content-start");
      cardElement.addClass("bg-white");
      var timestampElement = $("<div>").addClass("d-flex align-items-center justify-content-start text-sm opacity-6");
      var timestampIconElement = $("<i>").addClass("fa fa-check-double mr-1 text-xs");
      var timestampTextElement = $("<small>").text(getFormattedTimestamp(timestamp));

      // create the message text
      var messageTextElement = $("<p>").addClass("mb-1").css({
            "white-space": "pre-wrap",
            "overflow-wrap": "break-word",
            "word-break": "break-all",

            "max-width": "45ch"
            
          }).text(messageData);
        var textLength = messageTextElement.text().length;

        messageTextElement.attr("id", "clientmessage");
        var textLength = messageTextElement.text().length;


      //alert(lengths)

      // append the message text and timestamp to the card body
      cardBodyElement.append(messageTextElement, timestampElement);
      timestampElement.append(timestampIconElement, timestampTextElement);

    }

    // append the card body to the card
    cardElement.append(cardBodyElement);

    // append the card to the column
    colElement.append(cardElement);

    // append the column to the message element
    messageElements.append(colElement);

    // append the message element to the message body
    messageBody.append(messageElements);

    // scroll to the bottom of the message body
    messageBody.scrollTop(messageBody[0].scrollHeight);
      }
   } 
  function loadMessages() {
    var urlParams = new URLSearchParams(window.location.search);
    var chatNoder = urlParams.get("chatid");

      database.ref('Chats/' + chatNoder).orderByChild('chatid').equalTo(chatNoder).on('child_added', function(snapshot) {
        
      addMessage(snapshot);

    });
  }
  
  function clearMessages() {
    var urlParams = new URLSearchParams(window.location.search);
    var chatNoder = urlParams.get("chatid");

      database.ref('Chats/' + chatNoder).orderByChild('chatid').equalTo(chatNoder).off('child_added');

    messageBody.empty();
  }

  clearMessages();
  loadMessages();
  
  }); 
}); 
window.onpopstate = function(event) {
  // get the current URL
  var urlParams = new URLSearchParams(window.location.search);
  var chatNoded = urlParams.get("chatid");
  database.ref('Chats/' +  chatNoded).orderByChild('chatid').equalTo(chatNoded).off('child_added');


};

//ADMIN SEND MESSAGE
function getFormattedTimestamp(timestamp) {
  var date = new Date(timestamp);
  var hours = date.getHours();
  var minutes = date.getMinutes();
  var ampm = hours >= 12 ? "pm" : "am";
  hours = hours % 12;
  hours = hours ? hours : 12;
  minutes = minutes < 10 ? "0" + minutes : minutes;
  var strTime = hours + ":" + minutes + " " + ampm;
  return strTime;
    }
function addMessagess(snapshot) {
  var messageBody = $("#messagebody");
    // get the message data
    var messageData = snapshot.val().message;
    var sender = snapshot.val().sender;
    var timestamp = snapshot.val().timestamp;
    var chatid = snapshot.val().chatid;

var urlParams = new URLSearchParams(window.location.search);
 var currentChatNode = urlParams.get("chatid");


if (chatid === currentChatNode) {
    // create HTML elements to display the message
    var messageElements = $("<div>").addClass("row mb-4");
    var colElement = $("<div>").addClass("col-auto");

    // create the message card
    var cardElement = $("<div>").addClass("card text-white");

    // create the card body
    var cardBodyElement = $("<div>").addClass("card-body p-2");

    // add a class to the message element based on the sender
    if (sender === "admin") {
      messageElements.addClass("justify-content-end");
      cardElement.addClass("bg-custom");
      var timestampElement = $("<div>").addClass("d-flex align-items-center justify-content-end text-sm opacity-6");
      var timestampIconElement = $("<i>").addClass("fa fa-check-double mr-1 text-xs");
      var timestampTextElement = $("<small>").text(getFormattedTimestamp(timestamp));

      // create the message text
      var messageTextElement = $("<p>").addClass("mb-1").css({
        "white-space": "pre-wrap",
        "overflow-wrap": "break-word",
        "word-break": "break-all",
        "max-width": "45ch"
      }).text(messageData);
      var textLength = messageTextElement.text().length;

      if (textLength > 10) {
    
          messageTextElement.css("white-space", "pre-wrap");
      }
      // append the message text and timestamp to the card body
      cardBodyElement.append(messageTextElement, timestampElement);
      timestampElement.append(timestampIconElement, timestampTextElement);

    } else {
      messageElements.addClass("justify-content-start");
      cardElement.addClass("bg-white");
      var timestampElement = $("<div>").addClass("d-flex align-items-center justify-content-start text-sm opacity-6");
      var timestampIconElement = $("<i>").addClass("fa fa-check-double mr-1 text-xs");
      var timestampTextElement = $("<small>").text(getFormattedTimestamp(timestamp));

      // create the message text
      var messageTextElement = $("<p>").addClass("mb-1").css({
          "white-space": "pre-wrap",
          "overflow-wrap": "break-word",
          "word-break": "break-all",
          "max-width": "45ch"
        }).text(messageData);
        var textLength = messageTextElement.text().length;

        if (textLength > 10) {
            messageTextElement.css("white-space", "pre-wrap");
        }

      // append the message text and timestamp to the card body
      cardBodyElement.append(messageTextElement, timestampElement);
      timestampElement.append(timestampIconElement, timestampTextElement);

    }

    // append the card body to the card
    cardElement.append(cardBodyElement);

    // append the card to the column
    colElement.append(cardElement);

    // append the column to the message element
    messageElements.append(colElement);

    // append the message element to the message body
    messageBody.append(messageElements);

    // scroll to the bottom of the message body
    messageBody.scrollTop(messageBody[0].scrollHeight);
    
   

  }
}
function loadMessagess() {

    var urlParams = new URLSearchParams(window.location.search);
    var chatNoder = urlParams.get("chatid");
     database.ref('Chats/' + chatNoder).orderByChild('chatid').equalTo(chatNoder).on('child_added', function(snapshot) {
      
      addMessagess(snapshot);
    });
  }
  
  function clearMessagess() {
    var urlParams = new URLSearchParams(window.location.search);
    var chatNoder = urlParams.get("chatid");
    database.ref('Chats/' + chatNoder).orderByChild('chatid').equalTo(chatNoder).off('child_added');
    var messageBody = $("#messagebody");
    messageBody.empty();
  }
  
$('#btnsend').on('click', function() {
 var idmsg = $("#adminmessage").val();
 var message = {
             
                 sender: usernamed,
                 message: idmsg,
                 timestamp: firebase.database.ServerValue.TIMESTAMP,
                 chatid:chatNodes
 }
 $("#adminmessage").val("");
 database.ref('Chats/' + chatNodes).push(message, function() {
  clearMessagess();
  loadMessagess();

  var chatNotifRef = database.ref('ChatNotif').push();

// Get the unique ID generated by push()
var chatnid = "CN" + chatNotifRef.key;

var messagenotif ="You have new message from vet";

var chatnotifdata = {
    cnotif : chatnid,
    message : messagenotif,
    ownerid : idowner,
    timestamp: firebase.database.ServerValue.TIMESTAMP,
    status : "sent",
    isOpen : "No"
}

database.ref('ChatNotif/' + chatnid).set(chatnotifdata);   

    });
    return false;

    // Generate a new unique key for the pet registration

 });

 $('#adminmessage').on('keydown', function(event) {
  if (event.keyCode === 13) { // Enter key code
    $('#btnsend').trigger('click'); // Triggers click event on send button
    return false; // Prevents the default behavior of the Enter key
  }
});

var notifs = database.ref('AdminNotification');
notifs.orderByChild("timestamp").on("value", function(snapshot) {
  document.getElementById("admin-notif").innerHTML ="";
  var notifications = [];
  snapshot.forEach(function(childSnapshot) {
    notifications.push(childSnapshot);
  });
  notifications.reverse(); // reverse the array to show the latest notification first
  notifications.forEach(function(childSnapshot) {
    // display the notification
    var photo = childSnapshot.val().photoUrl;
    var firstname =  childSnapshot.val().firstname;
    var lastname = childSnapshot.val().lastname;
    var date = childSnapshot.val().apt_date;
    var time = childSnapshot.val().apt_time;
    var petname = childSnapshot.val().petname;
    var datenotif = childSnapshot.val().datenotif;
    var timestamp = childSnapshot.val().timestamp;
    var notype = childSnapshot.val().notype;

    
    var now = new Date().getTime();
    var elapsedMinutes = Math.floor((now - timestamp) / (1000 * 60))

    const message1 = document.createElement('a');
    message1.classList.add('dropdown-item');

    const newDiv = document.createElement('div');

    // Set the class name of the div element
    newDiv.className = 'dropdown-divider';
    const media1 = document.createElement('div');
    media1.classList.add('media');
    message1.appendChild(media1);

    const img1 = document.createElement('img');
      if (photo == "default_photo_url.jpg") {
        // If the photo is null, set the src attribute to the default user image
        img1.setAttribute('src', '../../dist/img/user.png');
      } else {
        // If the photo is not null, set the src attribute to the photo data
        img1.setAttribute('src', photo);
      }
    img1.style.height ="50px";
    img1.style.width ="50px";
    img1.style.objectFit ="cover";
    img1.setAttribute('alt', 'User Avatar');
    img1.classList.add('img-size-50', 'mr-3', 'img-circle');
    media1.appendChild(img1);

    const mediaBody1 = document.createElement('div');
    mediaBody1.classList.add('media-body');
    media1.appendChild(mediaBody1);

    const p1 = document.createElement('p');
    p1.classList.add('text-xs');
    p1.style.fontSize = "10px";
    p1.innerHTML = '<b>' + firstname +" " + lastname +'</b> has requested appointment for <b>'+ petname + '</b> on <b>' + date  + '</b> at <b>' + time + '</b>';


    const p21 = document.createElement('p');
    p21.classList.add('text-xs');
    p21.style.fontSize = "10px";
    p21.innerHTML = '<b>' + firstname +" " + lastname + '</b> has sent symptoms for '+ petname + ' .Please check the analytics page to evaluate the pet symptoms. Thank you. ';
  

    const p22 = document.createElement('p');
    p22.classList.add('text-xs');
    p22.style.fontSize = "10px";
    p22.innerHTML = '<b>' + firstname +" " + lastname + '</b> has updated the appointment for '+'<b>'+ petname +'</b>'+ ' on <b>' + date  + '</b> at <b>' + time + '</b>';

    const p23 = document.createElement('p');
    p23.classList.add('text-xs');
    p23.style.fontSize = "10px";
    p23.innerHTML = '<b>' + firstname +" " + lastname + '</b> has cancelled the confirmed appointment for '+'<b>'+ petname +'</b>'+ ' on <b>' + date  + '</b> at <b>' + time + '</b>';

    
    const p24 = document.createElement('p');
    p24.classList.add('text-xs');
    p24.style.fontSize = "10px";
    p24.innerHTML = '<b>' + firstname +" " + lastname + '</b> has cancelled the requested appointment for '+'<b>'+ petname +'</b>'+ ' on <b>' + date  + '</b> at <b>' + time + '</b>';

    if(notype == "OwnerSymp"){
      mediaBody1.appendChild(p21);
    }
    if(notype == "OwnerApt"){
      mediaBody1.appendChild(p1);
    }
    if(notype == "OwnerAptUpd"){
      mediaBody1.appendChild(p22);
    }
    if(notype == "OwnerAptCUpd"){
      mediaBody1.appendChild(p23);
    }
    if(notype == "OwnerAptRUpd"){
      mediaBody1.appendChild(p24);
    }
    const h31 = document.createElement('h3');
    h31.classList.add('dropdown-item-title');
    h31.style.visibility ="hidden";
    h31.style.position = "absolute";
    h31.textContent = firstname+ " " +lastname;
    mediaBody1.appendChild(h31);

    
    const span1 = document.createElement('span');
    span1.classList.add('float-right', 'text-sm', 'text-danger');
    const icon1 = document.createElement('i');
    icon1.classList.add('fas', 'fa-star');
    span1.appendChild(icon1);
    h31.appendChild(span1);


    const p3 = document.createElement('p');
    p3.classList.add('text-xs', 'text-muted');
    p3.innerHTML = '<i class="far fa-clock mr-1"></i>' + getElapsedTimeString(elapsedMinutes);
    mediaBody1.appendChild(p3);

    setInterval(function() {
        elapsedMinutes = Math.floor((new Date().getTime() - timestamp) / (1000 * 60));
        p3.innerHTML = '<i class="far fa-clock mr-1"></i>' + getElapsedTimeString(elapsedMinutes);
    }, 60000);

    const divider = document.createElement('div');
    divider.classList.add('dropdown-divider');

    document.getElementById("admin-notif").appendChild(divider);
    document.getElementById("admin-notif").appendChild(message1);
    document.getElementById("admin-notif").appendChild(divider);

  
  });
});

function getElapsedTimeString(minutes) {
    if (minutes < 1) {
        return 'Just now';
    } else if (minutes < 60) {
        return minutes + ' minutes ago';
    } else if (minutes < 24 * 60) {
        var hours = Math.floor(minutes / 60);
        return hours + ' ' + (hours == 1 ? 'hour' : 'hours') + ' ago';
    } else if (minutes < 7 * 24 * 60) {
        var days = Math.floor(minutes / (24 * 60));
        return days + ' ' + (days == 1 ? 'day' : 'days') + ' ago';
    } else {
        var weeks = Math.floor(minutes / (7 * 24 * 60));
        return weeks + ' ' + (weeks == 1 ? 'week' : 'weeks') + ' ago';
    }
}

/*
var aptRefer = database.ref('Appointments');

// This function will be called whenever a child node in Analytics is changed
aptRefer.on('child_added', function(snapshot) {
  sum_table.ajax.reload();


});*/

var count = 0;
  var counNotif = database.ref('AdminNotification')
  counNotif.on('child_added', function(childSnapshot) {
    var id = childSnapshot.val().adminotif;
    var status = childSnapshot.val().isOpen;
    var message = childSnapshot.val().message;
    var photo = childSnapshot.val().photoUrl;
    var stat = childSnapshot.val().status;

    if(stat == "sent"){
      $(document).Toasts('create', {
        autohide: true ,
        delay: 3500,
        body: '<div class="media">' +
              '<img class="img-size-50 mr-3 img-circle" style="border-radius: 50%; height: 50px; width: 50px; object-fit: cover; margin-right: 10px;" src="' + (photo === "default_photo_url.jpg" ? "../../dist/img/user.png" : photo) + '"">' +
              '<div class="media-body">' + message
              +'</div>' +
          '</div>',
        position: 'bottomLeft',
        style: {
          rtl: true
        }
      });

// append the toast to the container
$('.toast').appendTo('#myToastContainer');


var newStat = {
              status: "received",
            };
    database.ref('AdminNotification/' + id).update(newStat); 
}

    if(status === "No") {
      var countElement = document.getElementById("notification-count");
      count++;
      countElement.style.backgroundColor = "#ff0000";
      countElement.style.visibility = "visible";
      countElement.textContent = count.toString();
      $(document).ready(function() {

});
    }

  });

  $('#btnnotifadmin').on('click', function() {
    count = 0;
    var countElement = document.getElementById("notification-count");
  countElement.style.backgroundColor = "transparent";
  countElement.style.visibility = "hidden";
  countElement.textContent = "";
  database.ref('AdminNotification').once('value', function(snapshot) {
  snapshot.forEach(function(childSnapshot) {
    childSnapshot.ref.update({
      isOpen: "Yes"
         });
      });
    });
  });

  var newcount = 0;
var countPending = document.getElementById("countReq");
var countPend = database.ref('Appointments');

countPend.on('child_added', function(childSnapshot) {

  var statpen = childSnapshot.val().apt_stat;
  if (statpen === "Pending") {
    countPending.textContent ="";
    newcount++;
    countPending.textContent = newcount.toString();
  }
});

countPend.on('child_changed', function(childSnapshot) {
  countPending.textContent ="";
  var statpen = childSnapshot.val().apt_stat;
  var prevStatpen = childSnapshot.previous?.val()?.apt_stat;
  
  if (statpen === "Cancelled" && prevStatpen !== "Cancelled") {
    countPending.textContent ="";
    newcount--;
    countPending.textContent = newcount.toString();
  } else if (statpen !== prevStatpen && (statpen === "Pending" || prevStatpen === "Pending")) {
    countPending.textContent ="";
    if (newcount > 0) {
      newcount--;
      countPending.textContent = newcount.toString();
    }
    if (statpen === "Pending") {
      newcount++;
      countPending.textContent = newcount.toString();
    }
  }
});

var newcountrep = 0;
var countReport = document.getElementById("countRep");
var countReps = database.ref('Analytics');
countReps.on('child_added', function(childSnapshot) {
  var statrep =  childSnapshot.val().status;
  if(statrep === "Pending") {
    newcountrep++;
    countReport.textContent = newcountrep.toString();
  }
});
countReps.on('child_changed', function(childSnapshot) {
  var statrep =  childSnapshot.val().apt_stat;
  if(statrep === "Pending") {
    newcountrep++;
    countReport.textContent = newcountrep.toString();
  } else {
    newcountrep--;
    countReport.textContent = newcountrep.toString();
  }
});
const users = JSON.parse(sessionStorage.getItem('username'));
if(users != "admin"){
  window.location.replace("../../petriots/index.html");
}
  $('#logoutbtn').on('click', function() {
  const user = JSON.parse(sessionStorage.removeItem('username'));
  window.location.href = "../../petriots/index.html";
});
  
</script>
</body>
</html>
